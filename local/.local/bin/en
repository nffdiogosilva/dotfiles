#!/bin/bash
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  echo "en - English proofreader powered by Ollama (gemma3:4b)"
  echo ""
  echo "Usage: en <text>"
  echo "       echo <text> | en"
  echo ""
  echo "Fixes grammar, spelling, and punctuation. Improves fluency without changing meaning."
  exit 0
fi

if [ $# -gt 0 ]; then
  TEXT="$*"
elif [ ! -t 0 ]; then
  TEXT=$(cat)
else
  echo "Usage: en <text> or echo <text> | en (use -h for help)" >&2
  exit 1
fi

[ -z "$TEXT" ] && exit 0

SYSTEM='You are an English proofreader. Fix grammar, spelling, and punctuation errors. Improve fluency and naturalness where needed. Do NOT add new ideas or remove meaning. Do NOT rephrase beyond what is necessary for correctness and fluency. Keep the original tone and intent. Output ONLY the corrected text, nothing else.'

PAYLOAD=$(jq -n --arg sys "$SYSTEM" --arg text "$TEXT" '{
  "model": "gemma3:4b",
  "messages": [
    {"role": "system", "content": $sys},
    {"role": "user", "content": $text}
  ],
  "stream": false
}')

curl -s http://localhost:11434/api/chat -d "$PAYLOAD" | jq -r '.message.content'
